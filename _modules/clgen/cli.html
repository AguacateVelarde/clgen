<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>clgen.cli &#8212; clgen 0.3.10 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3.10',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">clgen 0.3.10 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../clgen.html" accesskey="U">clgen</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for clgen.cli</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright 2016, 2017 Chris Cummins &lt;chrisc.101@gmail.com&gt;.</span>
<span class="c1">#</span>
<span class="c1"># This file is part of CLgen.</span>
<span class="c1">#</span>
<span class="c1"># CLgen is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># CLgen is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with CLgen.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Command line interface to clgen.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">argparse</span> <span class="k">import</span> <span class="n">ArgumentParser</span><span class="p">,</span> <span class="n">FileType</span><span class="p">,</span> <span class="n">RawDescriptionHelpFormatter</span>
<span class="kn">from</span> <span class="nn">labm8</span> <span class="k">import</span> <span class="n">jsonutil</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">exit</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TextIO</span>

<span class="kn">import</span> <span class="nn">clgen</span>
<span class="kn">from</span> <span class="nn">clgen</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">clgen</span> <span class="k">import</span> <span class="n">dbutil</span>

<span class="n">__help_epilog__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Copyright (C) 2016, 2017 Chris Cummins &lt;chrisc.101@gmail.com&gt;.</span>
<span class="s2">&lt;http://chriscummins.cc/clgen&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="getself"><a class="viewcode-back" href="../../api/index.html#clgen.cli.getself">[docs]</a><span class="k">def</span> <span class="nf">getself</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; decorator to pass function as first argument to function &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="ReadableFilesOrDirectories"><a class="viewcode-back" href="../../api/index.html#clgen.cli.ReadableFilesOrDirectories">[docs]</a><span class="k">class</span> <span class="nc">ReadableFilesOrDirectories</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adapted from @mgilson http://stackoverflow.com/a/11415816</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;ReadableFilesOrDirectories:</span><span class="si">{path}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;ReadableFilesOrDirectories:</span><span class="si">{path}</span><span class="s2"> is not readable&quot;</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span></div>


<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../api/index.html#clgen.cli.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the given method as the main entrypoint to a program.</span>

<span class="sd">    If an exception is thrown, print error message and exit.</span>

<span class="sd">    If environmental variable DEBUG=1, then exception is not caught.</span>

<span class="sd">    Args:</span>
<span class="sd">        method (function): Function to execute.</span>
<span class="sd">        *args (str): Arguments for method.</span>
<span class="sd">        **kwargs (dict): Keyword arguments for method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        method(*args, **kwargs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_user_message</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="si">{err}</span><span class="s2"> (</span><span class="si">{type}</span><span class="s2">)</span>

<span class="s2">Please report bugs at &lt;https://github.com/ChrisCummins/clgen/issues&gt;</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_user_message_with_stacktrace</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
        <span class="c1"># get limited stack trace</span>
        <span class="k">def</span> <span class="nf">_msg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fnname</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">loc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">:</span><span class="si">{lineno}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">())</span>
            <span class="k">return</span> <span class="s2">&quot;      #</span><span class="si">{n}</span><span class="s2">  </span><span class="si">{loc: &lt;18}</span><span class="s2"> </span><span class="si">{fnname}</span><span class="s2">()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">())</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">NUM_ROWS</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># number of rows in traceback</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">NUM_ROWS</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_msg</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trace</span><span class="p">))</span>

        <span class="n">log</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="si">{err}</span><span class="s2"> (</span><span class="si">{type}</span><span class="s2">)</span>

<span class="s2">  stacktrace:</span>
<span class="si">{stack_trace}</span><span class="s2"></span>

<span class="s2">Please report bugs at &lt;https://github.com/ChrisCummins/clgen/issues&gt;</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">stack_trace</span><span class="o">=</span><span class="n">message</span><span class="p">))</span>

    <span class="c1"># if DEBUG var set, don&#39;t catch exceptions</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># verbose stack traces. see: https://pymotw.com/2/cgitb/</span>
        <span class="kn">import</span> <span class="nn">cgitb</span>
        <span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">runctx</span><span class="p">():</span>
            <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">()</span> <span class="ow">and</span> <span class="n">log</span><span class="o">.</span><span class="n">is_verbose</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s1">&#39;runctx()&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">locals</span><span class="p">(),</span> <span class="n">sort</span><span class="o">=</span><span class="s1">&#39;tottime&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">runctx</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">clgen</span><span class="o">.</span><span class="n">UserError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>  <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">keyboard interrupt, terminating&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">clgen</span><span class="o">.</span><span class="n">UserError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_user_message</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">clgen</span><span class="o">.</span><span class="n">File404</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_user_message</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_user_message_with_stacktrace</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<span class="nd">@getself</span>
<span class="k">def</span> <span class="nf">_register_test_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the CLgen self-test suite.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">coveragerc_path</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">coverage_path</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">clgen.test</span>

        <span class="k">if</span> <span class="n">coveragerc_path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">clgen</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">coveragerc_path</span><span class="p">())</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coverage_path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">clgen</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">coverage_report_path</span><span class="p">())</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">clgen</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">testsuite</span><span class="p">())</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;run the testsuite&quot;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                               <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--coveragerc-path&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;print path to coveragerc file&quot;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--coverage-path&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;print path to coverage file&quot;</span><span class="p">)</span>


<span class="nd">@getself</span>
<span class="k">def</span> <span class="nf">_register_train_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train a CLgen model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">model_file</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_json</span> <span class="o">=</span> <span class="n">jsonutil</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">model_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">model_json</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;tr&quot;</span><span class="p">],</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;train models&quot;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                               <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;model_file&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;model&gt;&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to model specification file&quot;</span><span class="p">)</span>


<span class="nd">@getself</span>
<span class="k">def</span> <span class="nf">_register_sample_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample a model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">model_file</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">sampler_file</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_json</span> <span class="o">=</span> <span class="n">jsonutil</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">model_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">model_json</span><span class="p">)</span>

        <span class="n">sampler_json</span> <span class="o">=</span> <span class="n">jsonutil</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">sampler_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">Sampler</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">sampler_json</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;sa&quot;</span><span class="p">],</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;train and sample models&quot;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                               <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;model_file&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;model&gt;&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to model specification file&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;sampler_file&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;sampler&gt;&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to sampler specification file&quot;</span><span class="p">)</span>


<span class="nd">@getself</span>
<span class="k">def</span> <span class="nf">_register_fetch_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Import OpenCL files into kernel datbase.</span>

<span class="sd">    The kernel database is used as a staging ground for input files, which are</span>
<span class="sd">    then preprocessed and assembled into corpuses. This program acts as the front</span>
<span class="sd">    end, assembling files from the file system into a database for preprocessing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@getself</span>
    <span class="k">def</span> <span class="nf">_register_fs_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch files from local filesystem.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">db_file</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clgen</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">db_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">paths</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;fetch from filesystem&quot;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                   <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;db_file&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;db&gt;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">),</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to SQL dataset&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;paths&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;path&gt;&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="n">ReadableFilesOrDirectories</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to OpenCL files or directories&quot;</span><span class="p">)</span>

    <span class="nd">@getself</span>
    <span class="k">def</span> <span class="nf">_register_github_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mines OpenCL kernels from Github. Requires the following environment</span>
<span class="sd">        variables to be set:</span>

<span class="sd">             GITHUB_USERNAME   github username</span>
<span class="sd">             GITHUB_PW         github password</span>
<span class="sd">             GITHUB_TOKEN      github api token</span>

<span class="sd">        For instructions to generate an API token, see:</span>

<span class="sd">          &lt;https://help.github.com/articles/creating-an-access-token-for-command-line-use/&gt;</span>

<span class="sd">        This process issues thousands of GitHub API requests per minute. Please</span>
<span class="sd">        exercise restrained in minimizing your use of this program -- we don&#39;t</span>
<span class="sd">        want to upset the nice folks at GH :-)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">db_file</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">environ</span>
            <span class="kn">from</span> <span class="nn">github</span> <span class="k">import</span> <span class="n">BadCredentialsException</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GITHUB_USERNAME&#39;</span><span class="p">]</span>
                <span class="n">password</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GITHUB_PW&#39;</span><span class="p">]</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GITHUB_TOKEN&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s1">&#39;environment variable </span><span class="si">{}</span><span class="s1"> not set&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">fetch_github</span><span class="p">(</span><span class="n">db_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BadCredentialsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;bad GitHub credentials&quot;</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;github&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;mine OpenCL from GitHub&quot;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                   <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;db_file&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;db&gt;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">),</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to SQL dataset&#39;</span><span class="p">)</span>

    <span class="n">fetch</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;fetch&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;fe&quot;</span><span class="p">],</span>
                              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;gather training data&quot;</span><span class="p">,</span>
                              <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                              <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
    <span class="n">subparser</span> <span class="o">=</span> <span class="n">fetch</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;available commands&quot;</span><span class="p">)</span>

    <span class="n">subparsers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_register_fs_parser</span><span class="p">,</span>
        <span class="n">_register_github_parser</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">register_fn</span> <span class="ow">in</span> <span class="n">subparsers</span><span class="p">:</span>
        <span class="n">register_fn</span><span class="p">(</span><span class="n">subparser</span><span class="p">)</span>


<span class="nd">@getself</span>
<span class="k">def</span> <span class="nf">_register_ls_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="nd">@getself</span>
    <span class="k">def</span> <span class="nf">_register_files_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Import OpenCL files into kernel datbase.</span>

<span class="sd">        The kernel database is used as a staging ground for input files, which</span>
<span class="sd">        are then preprocessed and assembled into corpuses. This program acts as</span>
<span class="sd">        the front end, assembling files from the file system into a database for</span>
<span class="sd">        preprocessing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">model_file</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">sampler_file</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_json</span> <span class="o">=</span> <span class="n">jsonutil</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">model_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">model_json</span><span class="p">)</span>

            <span class="n">caches</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">corpus</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">cache</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">sampler_file</span><span class="p">:</span>
                <span class="n">sampler_json</span> <span class="o">=</span> <span class="n">jsonutil</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">sampler_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">sampler</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">Sampler</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">sampler_json</span><span class="p">)</span>
                <span class="n">caches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>

            <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">types</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">abspaths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">caches</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;list cached files&quot;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                   <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;model_file&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;model&gt;&quot;</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to model specification file&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;sampler_file&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;sampler&gt;&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to sampler specification file&quot;</span><span class="p">)</span>

    <span class="nd">@getself</span>
    <span class="k">def</span> <span class="nf">_register_models_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List all locally cached models.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">clgen</span><span class="o">.</span><span class="n">models_to_tab</span><span class="p">(</span><span class="o">*</span><span class="n">clgen</span><span class="o">.</span><span class="n">models</span><span class="p">()))</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;list cached models&quot;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                   <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>

    <span class="nd">@getself</span>
    <span class="k">def</span> <span class="nf">_register_samplers_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List all locally cached samplers.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;not implemented&quot;</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;samplers&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;list cached samplers&quot;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                   <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;ls&quot;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;list files&quot;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                               <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
    <span class="n">subparser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;available commands&quot;</span><span class="p">)</span>

    <span class="n">_register_files_parser</span><span class="p">(</span><span class="n">subparser</span><span class="p">)</span>
    <span class="n">_register_models_parser</span><span class="p">(</span><span class="n">subparser</span><span class="p">)</span>
    <span class="n">_register_samplers_parser</span><span class="p">(</span><span class="n">subparser</span><span class="p">)</span>


<span class="nd">@getself</span>
<span class="k">def</span> <span class="nf">_register_db_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utilities for managing content databases.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@getself</span>
    <span class="k">def</span> <span class="nf">_register_init_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utilities for managing content databases.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">db_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">github</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create an empty OpenCL kernel database.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">dbutil</span><span class="o">.</span><span class="n">create_db</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">github</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">db_file</span><span class="p">))</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;create a database&quot;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                   <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;db_file&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;db&gt;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to SQL dataset&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="s1">&#39;--github&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;generate dataset with GitHub metadata&#39;</span><span class="p">)</span>

    <span class="nd">@getself</span>
    <span class="k">def</span> <span class="nf">_register_explore_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exploratory analysis of preprocessed dataset.</span>

<span class="sd">        Provides an overview of the contents of an OpenCL kernel database.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">db_file</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">):</span>
            <span class="n">clgen</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="n">db_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;explore&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show database stats&quot;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                   <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;db_file&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;db&gt;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">),</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to SQL dataset&#39;</span><span class="p">)</span>

    <span class="nd">@getself</span>
    <span class="k">def</span> <span class="nf">_register_merge_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge kernel datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">db_out</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BinaryIO</span><span class="p">]):</span>
            <span class="n">dbutil</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">db_out</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">])</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;merge&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;merge databases&quot;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">_main</span><span class="p">),</span>
                                   <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;db_out&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;db&gt;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;wb&quot;</span><span class="p">),</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to output database&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;db&gt;&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">),</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to database(s) to merge&quot;</span><span class="p">)</span>

    <span class="nd">@getself</span>
    <span class="k">def</span> <span class="nf">_register_dump_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump kernel dataset to file(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">db_file</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">outpath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">eof</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">file_sep</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">input_samples</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">status</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dbutil</span><span class="o">.</span><span class="n">dump_db</span><span class="p">(</span><span class="n">db_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="nb">dir</span><span class="p">,</span> <span class="n">eof</span><span class="o">=</span><span class="n">eof</span><span class="p">,</span>
                           <span class="n">fileid</span><span class="o">=</span><span class="n">file_sep</span><span class="p">,</span> <span class="n">input_samples</span><span class="o">=</span><span class="n">input_samples</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;dump&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;export database contents&quot;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">_main</span><span class="p">),</span>
                                   <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;db_file&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;db&gt;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">),</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to kernels database&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;outpath&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;path&gt;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to output file or directory&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="s2">&quot;--dir&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output to directory (overrides -i, --eof, -r)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--file-sep&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;include file separators&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--input-samples&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use input contents, not preprocessed&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--eof&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;print end of file&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--reverse&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use reverse order&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--status&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;status code to use&#39;</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;manage databases&quot;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                               <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
    <span class="n">subparser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;available commands&quot;</span><span class="p">)</span>

    <span class="n">subparsers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_register_init_parser</span><span class="p">,</span>
        <span class="n">_register_explore_parser</span><span class="p">,</span>
        <span class="n">_register_merge_parser</span><span class="p">,</span>
        <span class="n">_register_dump_parser</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">register_fn</span> <span class="ow">in</span> <span class="n">subparsers</span><span class="p">:</span>
        <span class="n">register_fn</span><span class="p">(</span><span class="n">subparser</span><span class="p">)</span>


<span class="nd">@getself</span>
<span class="k">def</span> <span class="nf">_register_preprocess_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process OpenCL files for machine learning.</span>

<span class="sd">    This is a three step process. First, the OpenCL kernels are compiled to</span>
<span class="sd">    bytecode, then the source files are preprocessed, before being rewritten.</span>

<span class="sd">    Preprocessing is computationally demanding and highly paralellised.</span>
<span class="sd">    Expect high resource contention during preprocessing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TextIO</span><span class="p">],</span> <span class="n">inputs_are_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
              <span class="n">gpuverify</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">remove_bad_preprocessed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
              <span class="n">remove_preprocessed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">input_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">infile</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">inputs_are_files</span> <span class="ow">and</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">clgen</span><span class="o">.</span><span class="n">preprocess_inplace</span><span class="p">(</span><span class="n">input_paths</span><span class="p">,</span> <span class="n">use_gpuverify</span><span class="o">=</span><span class="n">gpuverify</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">input_paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inputs_are_files</span><span class="p">:</span>
                    <span class="n">clgen</span><span class="o">.</span><span class="n">preprocess_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">use_gpuverify</span><span class="o">=</span><span class="n">gpuverify</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">remove_bad_preprocessed</span><span class="p">:</span>
                    <span class="n">dbutil</span><span class="o">.</span><span class="n">remove_bad_preprocessed</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">remove_preprocessed</span><span class="p">:</span>
                    <span class="n">dbutil</span><span class="o">.</span><span class="n">remove_preprocessed</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">clgen</span><span class="o">.</span><span class="n">preprocess_db</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">use_gpuverify</span><span class="o">=</span><span class="n">gpuverify</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nothing to be done.&quot;</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;preprocess&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;pp&quot;</span><span class="p">],</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;preprocess files for training&quot;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                               <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;path&gt;&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to input(s)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--file&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;inputs_are_files&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;treat input as file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--inplace&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;inplace file rewrite&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-G&#39;</span><span class="p">,</span> <span class="s1">&#39;--gpuverify&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;run GPUVerify on kernels&#39;</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--remove-bad-preprocessed&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">delete the contents of all bad or ugly preprocessed files,</span>
<span class="s2">but keep the entries in the table&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--remove-preprocessed&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;remove all preprocessed files from database&quot;</span><span class="p">)</span>


<span class="nd">@getself</span>
<span class="k">def</span> <span class="nf">_register_features_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract static OpenCL kernel features.</span>

<span class="sd">    This extracts the static compile-time features of the paper:</span>

<span class="sd">        Grewe, D., Wang, Z., &amp; O&#39;Boyle, M. F. P. M. (2013). Portable Mapping of</span>
<span class="sd">        Data Parallel Programs to OpenCL for Heterogeneous Systems. In CGO. IEEE.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">infiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TextIO</span><span class="p">],</span> <span class="n">dir_mode</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">summarise</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
              <span class="n">fatal_errors</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">use_shum</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
              <span class="n">no_header</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">clgen</span> <span class="k">import</span> <span class="n">features</span>

        <span class="n">input_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">infile</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">infiles</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">features_dir</span><span class="p">(</span><span class="n">csv_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fs</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">csv_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">summarise</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">input_paths</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_paths</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">features_dir</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">dir_mode</span><span class="p">:</span>
            <span class="n">trees</span> <span class="o">=</span> <span class="p">[</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">abspaths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">input_paths</span><span class="p">]</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">trees</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">fs</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">input_paths</span><span class="p">]</span>

        <span class="n">features</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">fatal_errors</span><span class="o">=</span><span class="n">fatal_errors</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
                       <span class="n">use_shim</span><span class="o">=</span><span class="n">use_shim</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="ow">not</span> <span class="n">no_header</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;extract OpenCL kernel features&quot;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                               <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;infiles&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;path&gt;&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;input path(s)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="s2">&quot;--dir&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;treat inputs as directories&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--stats&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;summarize&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;summarize features files&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="s2">&quot;--fatal-errors&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;quit on compiler error&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--shim&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;use_shim&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;include shim header&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;minimal error output&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;--no-header&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;no features header&quot;</span><span class="p">)</span>


<span class="nd">@getself</span>
<span class="k">def</span> <span class="nf">_register_atomize_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract and print corpus vocabulary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">infile</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">vocab</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">corpus</span><span class="o">.</span><span class="n">atomize</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">vocab</span><span class="o">=</span><span class="n">vocab</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;size:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;atomize&quot;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;atomize files&quot;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                               <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;infile&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;path&gt;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to input text file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--type&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;vocab&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;char&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;vocabulary type&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--size&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;print vocabulary size&quot;</span><span class="p">)</span>


<span class="nd">@getself</span>
<span class="k">def</span> <span class="nf">_register_cache_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manage filesystem cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@getself</span>
    <span class="k">def</span> <span class="nf">_register_migrate_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refresh the cached model, corpus, and sampler IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">cachepath</span><span class="p">()</span>

            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not Implemented: refresh corpuses&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fs</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">):</span>
                <span class="n">cached_modeldirs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">),</span> <span class="n">abspaths</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cached_modeldir</span> <span class="ow">in</span> <span class="n">cached_modeldirs</span><span class="p">:</span>
                    <span class="n">cached_model_id</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cached_modeldir</span><span class="p">)</span>
                    <span class="n">cached_meta</span> <span class="o">=</span> <span class="n">jsonutil</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">cached_modeldir</span><span class="p">,</span> <span class="s2">&quot;META&quot;</span><span class="p">))</span>

                    <span class="n">model</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">cached_meta</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cached_model_id</span> <span class="o">!=</span> <span class="n">model</span><span class="o">.</span><span class="n">hash</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cached_model_id</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">hash</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">fs</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;cache conflict&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

                        <span class="n">fs</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">cached_modeldir</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not Implemented: refresh samplers&quot;</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;migrate&quot;</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s2">&quot;migrate the cache&quot;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                   <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">dispatch_func</span><span class="o">=</span><span class="n">_main</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;cache&quot;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;manage filesystem cache&quot;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                               <span class="n">epilog</span><span class="o">=</span><span class="n">__help_epilog__</span><span class="p">)</span>

    <span class="n">subparser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;available commands&quot;</span><span class="p">)</span>

    <span class="n">subparsers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_register_migrate_parser</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">register_fn</span> <span class="ow">in</span> <span class="n">subparsers</span><span class="p">:</span>
        <span class="n">register_fn</span><span class="p">(</span><span class="n">subparser</span><span class="p">)</span>


<span class="nd">@getself</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../api/index.html#clgen.cli.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A deep learning program generator for the OpenCL programming language.</span>

<span class="sd">    The core operations of CLgen are:</span>

<span class="sd">       1. OpenCL files are collected from a model specification file.</span>
<span class="sd">       2. These files are preprocessed into an OpenCL kernel database.</span>
<span class="sd">       3. A training corpus is generated from the input files.</span>
<span class="sd">       4. A machine learning model is trained on the corpus of files.</span>
<span class="sd">       5. The trained model is sampled for new kernels.</span>
<span class="sd">       6. The samples are tested for compilability.</span>

<span class="sd">    This program automates the execution of all six stages of the pipeline.</span>
<span class="sd">    The pipeline can be interrupted and resumed at any time. Results are cached</span>
<span class="sd">    across runs. If installed with CUDA support, NVIDIA GPUs will be used to</span>
<span class="sd">    improve performance where possible.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="s2">&quot;clgen&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">For information about a specific command, run `clgen &lt;command&gt; --help`.</span>

<span class="s2">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">__help_epilog__</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;increase output verbosity&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show version information and exit&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--debug&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;in case of error, print debugging information&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--profile&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;enable internal API profiling. When combined with --verbose, &quot;</span>
              <span class="s2">&quot;prints a complete profiling trace&quot;</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--corpus-dir&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;corpus&gt;&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;print path to corpus cache&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--model-dir&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;model&gt;&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;print path to model cache&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--sampler-dir&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&lt;model&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;sampler&gt;&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;print path to sampler cache&quot;</span><span class="p">)</span>

    <span class="n">subparser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;available commands&quot;</span><span class="p">)</span>

    <span class="n">subparsers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_register_test_parser</span><span class="p">,</span>
        <span class="n">_register_train_parser</span><span class="p">,</span>
        <span class="n">_register_sample_parser</span><span class="p">,</span>
        <span class="n">_register_db_parser</span><span class="p">,</span>
        <span class="n">_register_fetch_parser</span><span class="p">,</span>
        <span class="n">_register_ls_parser</span><span class="p">,</span>
        <span class="n">_register_preprocess_parser</span><span class="p">,</span>
        <span class="n">_register_features_parser</span><span class="p">,</span>
        <span class="n">_register_atomize_parser</span><span class="p">,</span>
        <span class="n">_register_cache_parser</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">register_fn</span> <span class="ow">in</span> <span class="n">subparsers</span><span class="p">:</span>
        <span class="n">register_fn</span><span class="p">(</span><span class="n">subparser</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># set log level</span>
    <span class="n">log</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># set debug option</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>

    <span class="c1"># set profile option</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">profile</span><span class="p">:</span>
        <span class="n">prof</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

    <span class="c1"># options whch override the normal argument parsing process.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">version</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;clgen </span><span class="si">{version}</span><span class="s2"> made with </span><span class="se">\033</span><span class="s2">[1;31m♥</span><span class="se">\033</span><span class="s2">[0;0m by &quot;</span>
              <span class="s2">&quot;Chris Cummins &lt;chrisc.101@gmail.com&gt;.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">corpus_dir</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">jsonutil</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">corpus_dir</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">corpus</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">model_dir</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">jsonutil</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_dir</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sampler_dir</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">jsonutil</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sampler_dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">clgen</span><span class="o">.</span><span class="n">Sampler</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">jsonutil</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sampler_dir</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># strip the arguments from the top-level parser</span>
        <span class="n">dispatch_func</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dispatch_func</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;corpus_dir&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;model_dir&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;sampler_dir&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;dispatch_func&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>

        <span class="n">run</span><span class="p">(</span><span class="n">dispatch_func</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">clgen 0.3.10 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../clgen.html" >clgen</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Chris Cummins.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.5.
    </div>
  </body>
</html>